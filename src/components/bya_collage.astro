---
import Image from "astro/components/Image.astro";
import { Images, ByaPairs } from "../data/Images";


const pageName = "bya"
const imagesBefore = Images[pageName] || [];
const imagesAfter = Images[`${pageName}_a`] || [];

// Build pairs: if YAML has entries, use them to match by filename.
// Otherwise, fall back to index-based pairing from the glob results.
const byName = (name?: string) => name?.replace(/\.\w+$/, "");
const getByFilename = (list: typeof imagesBefore, filename?: string) => {
  const key = byName(filename);
  if (!key) return undefined;
  return list.find((img) => String(img.num) === key);
};

let resolvedPairs: Array<{ before: typeof imagesBefore[0] | undefined; after: typeof imagesAfter[0] | undefined; alt: string }>;

if (ByaPairs.length > 0) {
  resolvedPairs = ByaPairs.map((pair, index) => {
    const before = getByFilename(imagesBefore, pair.before) || imagesBefore[index];
    const after = getByFilename(imagesAfter, pair.after) || imagesAfter[index];
    return {
      before,
      after,
      alt: pair.alt || before?.alt || after?.alt || ""
    };
  }).filter((pair) => pair.before || pair.after);
} else {
  // No YAML entries: pair by index
  const len = Math.max(imagesBefore.length, imagesAfter.length);
  resolvedPairs = Array.from({ length: len }, (_, i) => ({
    before: imagesBefore[i],
    after: imagesAfter[i],
    alt: imagesBefore[i]?.alt || imagesAfter[i]?.alt || ""
  })).filter((pair) => pair.before || pair.after);
}

// Collect after images for preloading
const afterImages = resolvedPairs
  .map((p) => p.after)
  .filter((img): img is NonNullable<typeof img> => Boolean(img));
---
<head>
  {afterImages.map((img) => (
    <link rel="preload" as="image" href={img.src.src} />
  ))}
</head>
<span class="text-white text-center text-xl lg:text-3xl font-medium ">
    Click to edit!
</span>

<div id="collage" class="flex flex-wrap w-full max-w-screen pl-[calc(5vw_+_0.750rem)] pr-[5vw] gap-4">
    {
        resolvedPairs.map((pair) => {
            const img = pair.before || pair.after;
            if (!img) return null;

            const w1 = img.width || 1;
            const h1 = img.height || 1;

            return (
                <div style={`aspect-ratio: ${w1}/${h1};`} class="h-bya">
                    <Image
                        src={img.src}
                        alt={pair.alt}
                        width={w1}
                        height={h1}
                        class="w-full h-full object-cover cursor-pointer"
                        loading="eager"
                        data-after-src={pair.after?.src?.src || ""}
                        data-after-alt={pair.after?.alt || pair.alt}
                        data-current="before"
                        data-before-src={pair.before?.src?.src || ""}
                        data-before-alt={pair.before?.alt || pair.alt}
                    />
                </div>
            );
        })
    }
</div>
<script>
    const preloadImages = () => {
        document.querySelectorAll('.h-bya img').forEach(img => {
            const afterSrc = img.getAttribute('data-after-src');
            if (afterSrc) {
                const i = new Image();
                i.src = afterSrc;
                i.decoding = "async";
                i.onload = () => {
                    // Ensures the image is decoded
                    i.decode().catch(() => {});
                };
            }
        });
    };

    window.addEventListener("load", preloadImages);
</script>

<script>
    document.querySelectorAll('.h-bya img').forEach(img => {
        img.addEventListener('click', () => {
            // Change from before to after
            const htmlImg = img as HTMLImageElement;
            const afterSrc = htmlImg.getAttribute('data-after-src');
            const afterAlt = htmlImg.getAttribute('data-after-alt');
            const beforeSrc = htmlImg.getAttribute('data-before-src');
            const beforeAlt = htmlImg.getAttribute('data-before-alt');
            const current = htmlImg.getAttribute('data-current');

            if (current === 'before') {
                htmlImg.src = afterSrc || beforeSrc || "";
                htmlImg.alt = afterAlt || beforeAlt || "";
                htmlImg.setAttribute('data-current', 'after');
            } else {
                htmlImg.src = beforeSrc || "";
                htmlImg.alt = beforeAlt || "";
                htmlImg.setAttribute('data-current', 'before');
            }


        });
    });
</script>
